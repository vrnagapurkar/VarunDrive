<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - VarunDrive</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 50px; text-align: center; }
    .site-title { font-size: 28px; margin: 0 auto 18px; display: block; color: #222; text-decoration: none; }
    .card { display: block; text-align: left; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 720px; margin: 18px auto; }
    h2 { margin-top: 0; }
    button { padding: 8px 12px; background: #007bff; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px; }
    #fileList { margin-top: 12px; }
    a { color: #007bff; }
  </style>
</head>
<body>

  <a class="site-title" href="index.html">VarunDrive</a>

  <div class="card">
    <h2>Dashboard</h2>

    <div style="margin-bottom:12px;">
      <button id="logoutBtn">Logout</button>
      <button id="refreshBtn">Refresh Files</button>
    </div>

    <h3>Your Files</h3>
    <ul id="fileList"></ul>

    <p style="margin-top:16px;"><a href="upload.html">Upload New File</a></p>
  </div>

  <script>
  const API_BASE = "https://yn2y9x0yi5.execute-api.us-east-1.amazonaws.com/dev";
  const idToken = localStorage.getItem('idToken');
  const userId = localStorage.getItem('email');

  // Redirect to login if not logged in
  if (!idToken || !userId) {
    window.location.href = 'login.html';
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('idToken');
    localStorage.removeItem('email');
    window.location.href = 'login.html';
  });

  // Convert base64 â†’ Blob
  function base64ToBlob(base64) {
    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    return new Blob([bytes]);
  }

  // Load files from list Lambda (GET)
  async function loadFiles() {
    try {
      const res = await fetch(`${API_BASE}/list?userId=${encodeURIComponent(userId)}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${idToken}` }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const ul = document.getElementById('fileList');
      ul.innerHTML = '';

      if (!data.files || data.files.length === 0) {
        ul.innerHTML = '<li>No files uploaded yet.</li>';
        return;
      }

      data.files.forEach(file => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = file.fileName;

        // Click to download
        a.addEventListener('click', async () => {
          try {
            const downloadRes = await fetch(`${API_BASE}/download?userId=${encodeURIComponent(userId)}&fileId=${file.fileId}`, {
              method: 'GET',
              headers: { 'Authorization': `Bearer ${idToken}` }
            });
            if (!downloadRes.ok) throw new Error(`HTTP ${downloadRes.status}`);
            const fileData = await downloadRes.json();

            if (fileData.error) return alert(fileData.error);

            const blob = base64ToBlob(fileData.fileContent);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileData.fileName;
            link.click();
          } catch (err) {
            console.error("Download error:", err);
            alert("Failed to download file.");
          }
        });

        li.appendChild(a);
        ul.appendChild(li);
      });

    } catch (err) {
      console.error("Load files error:", err);
      alert("Failed to load files.");
    }
  }

  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', loadFiles);

  // Initial load
  window.onload = loadFiles;
  </script>
</body>
</html>
